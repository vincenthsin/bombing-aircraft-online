name: Deploy Backend to Render (Docker)

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository_owner }}/bombing-aircraft-backend

jobs:
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable={{is_default_branch}}
            type=sha,prefix={{branch}}-,format=short
            type=ref,event=branch
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
      
      - name: Image digest
        run: echo "Image pushed with digest ${{ steps.build.outputs.digest }}"

  deploy-render:
    name: Deploy to Render
    needs: build-and-push
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Trigger Render Deployment
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Deploying to Render..."
          
          # Trigger deployment using Render API
          RESPONSE=$(curl -X POST \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys" \
            -H "Authorization: Bearer ${RENDER_API_KEY}" \
            -H "Content-Type: application/json" \
            -d '{
              "clearCache": "do_not_clear"
            }')
          
          echo "Deployment triggered: $RESPONSE"
          
          # Extract deploy ID from response
          DEPLOY_ID=$(echo $RESPONSE | jq -r '.id // empty')
          
          if [ -z "$DEPLOY_ID" ]; then
            echo "Failed to trigger deployment. Response: $RESPONSE"
            exit 1
          fi
          
          echo "Deploy ID: $DEPLOY_ID"
          echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_ENV
      
      - name: Wait for deployment to complete
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          echo "Waiting for deployment to complete..."
          
          MAX_WAIT=600  # 10 minutes
          ELAPSED=0
          INTERVAL=15
          
          while [ $ELAPSED -lt $MAX_WAIT ]; do
            # Check deployment status
            STATUS_RESPONSE=$(curl -s \
              "https://api.render.com/v1/services/${RENDER_SERVICE_ID}/deploys/${DEPLOY_ID}" \
              -H "Authorization: Bearer ${RENDER_API_KEY}")
            
            STATUS=$(echo $STATUS_RESPONSE | jq -r '.status // empty')
            
            echo "Deployment status: $STATUS (${ELAPSED}s elapsed)"
            
            if [ "$STATUS" = "live" ]; then
              echo "Deployment completed successfully!"
              exit 0
            elif [ "$STATUS" = "build_failed" ] || [ "$STATUS" = "deploy_failed" ] || [ "$STATUS" = "canceled" ]; then
              echo "Deployment failed with status: $STATUS"
              exit 1
            fi
            
            sleep $INTERVAL
            ELAPSED=$((ELAPSED + INTERVAL))
          done
          
          echo "Deployment timed out after ${MAX_WAIT}s"
          exit 1

  health-check:
    name: Health Check
    needs: deploy-render
    runs-on: ubuntu-latest
    
    steps:
      - name: Get service URL
        id: get-url
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }}
          RENDER_SERVICE_ID: ${{ secrets.RENDER_SERVICE_ID }}
        run: |
          # Get service details to extract URL
          SERVICE_INFO=$(curl -s \
            "https://api.render.com/v1/services/${RENDER_SERVICE_ID}" \
            -H "Authorization: Bearer ${RENDER_API_KEY}")
          
          SERVICE_URL=$(echo $SERVICE_INFO | jq -r '.serviceDetails.url // empty')
          
          if [ -z "$SERVICE_URL" ]; then
            echo "Failed to get service URL"
            exit 1
          fi
          
          echo "SERVICE_URL=$SERVICE_URL" >> $GITHUB_ENV
          echo "Service URL: $SERVICE_URL"
      
      - name: Wait for service to be ready
        run: |
          echo "Waiting for service to be ready..."
          sleep 30
      
      - name: Health check
        run: |
          echo "Running health check on ${SERVICE_URL}/health"
          
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${SERVICE_URL}/health")
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "‚úÖ Health check passed! Service is healthy."
              echo "üöÄ Backend deployed successfully to: $SERVICE_URL"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check failed (attempt $RETRY_COUNT/$MAX_RETRIES). HTTP code: $HTTP_CODE"
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "Retrying in 10 seconds..."
              sleep 10
            fi
          done
          
          echo "‚ùå Health check failed after $MAX_RETRIES attempts"
          exit 1
      
      - name: Test API endpoints
        run: |
          echo "Testing API endpoints..."
          
          # Test health endpoint
          curl -f "${SERVICE_URL}/health" || exit 1
          
          # Test API base endpoint
          curl -f "${SERVICE_URL}/api" || echo "API base endpoint returned non-200"
          
          echo "‚úÖ All endpoint tests passed!"
